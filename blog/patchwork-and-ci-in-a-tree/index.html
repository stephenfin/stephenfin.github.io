<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Patchwork and CI in a Tree | that.guru</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="shortcut icon" href="https://that.guru/img/favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="stylesheet" href="https://that.guru/css/normalize.css">
  <link rel="stylesheet" href="https://that.guru/css/main.css">
  <link rel="preload" href="https://that.guru/css/syntax.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://that.guru/css/syntax.css"/>
  <link rel="preload" href="https://that.guru/css/fontawesome.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/fontawesome.css"/></noscript>
  <link rel="preload" href="https://that.guru/css/solid.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/solid.css"/></noscript>
  <link rel="preload" href="https://that.guru/css/brands.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/brands.css"/></noscript>
  <style type="text/css">
    .header-wrapper {
      background-image: url(https://source.unsplash.com/xY_6ZENqcfo/1920x1080);
    }
  </style>
</head>

<body>
<a class="home-button" href="https://that.guru/">
  <i class="fas fa-home"></i>
</a>

<div class="header-wrapper">
  <header class="header">
    <h1 class="title">Patchwork and CI in a Tree</h1>

    <nav class="site-nav">
      <div class="site-nav-left">
        <ul class="menu" role="menu">
          <li role="menuitem" class="menu-item"><a href="https://that.guru/blog">Blog</a></li>
          <li role="menuitem" class="menu-item"><a href="https://that.guru/talks">Talks</a></li>
          <li role="menuitem" class="menu-item"><a href="https://that.guru/about">About</a></li>
        </ul>
      </div>
      <div class="site-nav-right">
        <div class="social-links">
          <a class="social-link" alt="GitHub" href="https://github.com/stephenfin">
            <i class="fab fa-github"></i>
          </a>
          <a class="social-link" alt="Twitter" href="https://twitter.com/stephenfin">
            <i class="fab fa-twitter"></i>
          </a>
          <a class="social-link" alt="LinkedIn" href="https://linkedin.com/stephenfinucane">
            <i class="fab fa-linkedin"></i>
          </a>
          <a class="social-link" alt="RSS" href="https://that.guru/blog/index.xml">
            <i class="fas fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </header>
</div>

<div class="main-wrapper">
  <div class="main-inner">
    <main class="content">
  <div class="byline">
    <div class="byline-avatar">
      <a href="https://that.guru/about">
        <img src="https://www.gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=40&d=retro" />
      </a>
    </div>
    <div class="byline-meta">
      <div>
        <address class="author"><a rel="author" href="https://that.guru/about">Stephen Finucane</address></a></address>
      </div>
      <div class="byline-meta-content">
        <time datetime='2017-02-12T00:00:00Z'>Feb 12, 2017</time>
        <span class="byline-reading-time"><span class="bull">&nbsp;â€¢&nbsp;</span>12 min read</span>
      </div>
    </div>
  </div>

  <article>
    <p>This has been a long time in the works.</p>
<p>With the upcoming release of <a href="https://github.com/getpatchwork/patchwork/">Patchwork</a> 2.0, Patchwork will provides first
class support for series, or collections of patches, and expose these (and much
more besides) over a new REST API. Coupled with the <a href="https://github.com/getpatchwork/patchwork/releases/tag/v1.1.0">Check support added in
1.1</a>, we will be able to use Patchwork with continuous integration and
automated testing tools like Jenkins to validate projects using the mailing
list workflow.</p>
<p>Below is the result of my own experiments coupling Patchwork with Jenkins.  Be
aware that this represents but the very basics of what one can do with this
functionality. However, I aim to build upon this later and this should still
serve to illustrate most of the key concepts. An even simpler guide will be
available in the Patchwork documentation shortly.</p>
<p><strong>NOTE:</strong> This guide has been updated since publication to reflect the changes
found in Patchwork 2.0.</p>
<h2 id="initializing-services">Initializing Services</h2>
<p>Before we begin, we need to install both Patchwork and Jenkins. I chose to use
Docker for this, though Patchwork can also be installed manually.</p>
<h3 id="patchwork">Patchwork</h3>
<p>First up, Patchwork. Clone the Patchwork repo and bring up the project, as
described in the <a href="https://patchwork.readthedocs.io/en/latest/development/installation/">docs</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ git clone https://github.com/getpatchwork/patchwork

$ cd patchwork
$ docker-compose build
$ docker-compose up
</code></pre></div><p>Leave this running and jump to another tab.</p>
<p>You should also create an superuser that you can use manage the instance. I
used <code>admin</code> and <code>tester</code> for username and password, respectively:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose run --rm web python manage.py createsuperuser
</code></pre></div><p>Once initialized, you should be able to browse Patchwork at <code>localhost:8000</code>.
A default <code>Patchwork</code> project will have been created, which we will use for
this demo.</p>
<h3 id="jenkins">Jenkins</h3>
<p>Now for Jenkins. We&rsquo;ll follow the instructions provided on the the <a href="https://hub.docker.com/_/jenkins/">Docker
Hub</a> page. Run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker pull jenkins
$ docker run --name myjenkins -p 8080:8080 -p 50000:50000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -v /var/jenkins_home jenkins
</code></pre></div><p>Browse to the Jenkins URL (<code>localhost:8080</code>), where you will be asked to
authenticate, create a user, and select which plugins to install. I used
<code>admin</code> and <code>tester</code> for username and password once again, then chose the
following plugins:</p>
<ul>
<li>
<p>Git plugin</p>
</li>
<li>
<p>Parameterized Trigger plugin</p>
</li>
<li>
<p>Timestamper</p>
</li>
</ul>
<p>Note that you can install additional plugins if necessary but these are the
bare minimum.</p>
<h3 id="summary">Summary</h3>
<p>Once this step is completed, both services should be accessible: the Patchwork
instance at <code>localhost:8000</code> and the Jenkins instance at <code>localhost:8080</code>.
Both instances should have a user account configured, using the <code>admin</code>
username and <code>tester</code> password. Finally, the Patchwork instance should have the
default <code>Patchwork</code> project. Record all of these details for future steps.</p>
<h2 id="configuring-services">Configuring Services</h2>
<p>Once the services are initialized, we need to configure them.</p>
<h3 id="patchwork-1">Patchwork</h3>
<p>There isn&rsquo;t really much initial configuration necessary for Patchwork. You
should already have a user account created and Patchwork will use the default
default <code>Patchwork</code> project. One step that <em>is</em> necessary is to assign your
user, <code>admin</code> in this case, as a maintainer of the <code>Patchwork</code> project. This is
necessary to ensure we can upload test results, change the state of patches
etc. You can do this using the admin console:</p>
<pre><code>http://localhost:8000/admin/auth/user/1/change/
</code></pre>
<p>We also need to extract the IP address of the Docker container running the
Patchwork instance. This is necessary so Jenkins can communicate with the
instance. You can extract the IP address using <code>docker inspect</code>, per <a href="http://stackoverflow.com/a/20686101/613428">this
StackOverflow answer</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker inspect <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -f <span style="color:#e6db74">&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    &lt;CONTAINER_NAME_OR_ID&gt;
</code></pre></div><p>where <code>&lt;CONTAINER_NAME_OR_ID&gt;</code> refers to the active <code>patchwork_web</code> container.
This will return an IP address, in my case <code>172.17.0.3</code>. Ensure you can access
the Patchwork instance via this address (including port) - for example at
<code>172.17.0.3:8000</code> - then store this IP for later.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-1.png"
         alt="Screenshot of newly configured Patchwork instance"/> <figcaption>
            <h4>A Patchwork instance fresh out of the oven</h4>
        </figcaption>
</figure>

<h2 id="jenkins-1">Jenkins</h2>
<p>Before beginning, you should extract your user&rsquo;s &ldquo;token&rdquo;. We will use this to
talk to the Jenkins API in a later step. Browse to your user settings to obtain
this and copy it down somewhere:</p>
<pre><code>http://localhost:8080/user/admin/configure
</code></pre>
<p>Once you have this token stored, we can move onto configuring the Jenkins job.
We&rsquo;re going to make heavy use of <a href="https://wiki.jenkins-ci.org/display/JENKINS/Parameterized+Build">Parameterized Builds</a> and the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API">Remote
Access API</a>, both of which are part of the default Jenkins install.</p>
<p>Create a new &ldquo;freestyle&rdquo; project, setting the project name and description to
something useful. You also need to define two parameters:</p>
<ul>
<li>
<p><code>MBOX_URL</code></p>
<p>The URL to download the patch from.</p>
</li>
<li>
<p><code>CHECK_URL</code></p>
<p>The URL to report the test result to.</p>
</li>
</ul>
<p>While we could expand the available parameters to avoid hard-coding variables
and make the job more flexible, we&rsquo;re going to keep it simple for now.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-2.png"
         alt="Screenshot of General configuration"/> <figcaption>
            <h4>General</h4>
        </figcaption>
</figure>

<p>Next, configure Jenkins to check out the code from the project of choice in the
<em>Source Code Management</em> section. We&rsquo;re testing Patchwork, so we&rsquo;re going to
use Git and the GitHub repo. For reference, the Patchwork repo URL is:</p>
<pre><code>https://github.com/getpatchwork/patchwork.git
</code></pre>
<p>You don&rsquo;t need to specify credentials, nor should you change the default branch
specifier. You should, however, enable the <em>Clean before checkout</em> behavior, to
ensure old tests don&rsquo;t corrupt newer tests.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-3.png"
         alt="Screenshot of Source Code Management configuration"/> <figcaption>
            <h4>Source Code Management</h4>
        </figcaption>
</figure>

<p>For the <em>Build Triggers</em> section, we&rsquo;re going to trigger this remotely using
another script. Simply tick the relevant box and set an &ldquo;authentication token&rdquo;.
Use <code>hello-world</code> as a token.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-4.png"
         alt="Screenshot of Build Triggers configuration"/> <figcaption>
            <h4>Build Triggers</h4>
        </figcaption>
</figure>

<p>The <em>Build Environment</em> section can be mostly ignored. Simply enable timestamps
in the build output.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-5.png"
         alt="Screenshot of Build Environment configuration"/> <figcaption>
            <h4>Build Environment</h4>
        </figcaption>
</figure>

<p>Now for the juicy bit: <em>Build</em>. You&rsquo;ll want to execute four steps:</p>
<ol>
<li>
<p>Tell Patchwork (via the API) that we&rsquo;re kicking off the build</p>
</li>
<li>
<p>Download and apply the patch</p>
</li>
<li>
<p>Run the test(s)</p>
</li>
<li>
<p>Report the end result to Patchwork (again, via the API)</p>
</li>
</ol>
<p>A script provided below will do the job for you. This script will use the
username, password and IP address of the Patchwork instance, which we got
previously. Add a new &ldquo;Execute Shell&rdquo; build step to the <em>Build</em> section. Paste
the script provided below there, updating the IP address or credentials where
necessary:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/usr/bin/env bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Constants</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#75715e"># Patchwork credentials</span>

readonly PATCHWORK_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;172.17.0.3:8000&#34;</span>
readonly PATCHWORK_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
readonly PATCHWORK_PASS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tester&#34;</span>

<span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Functions</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#66d9ef">function</span> submit_check<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e"># Submit a check to Patchwork</span>
  <span style="color:#75715e">#</span>
  <span style="color:#75715e"># Args:</span>
  <span style="color:#75715e">#   $1 - the state to register</span>
  <span style="color:#75715e">#   $2 - an optional description</span>
  state<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
  description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>

  curl -X POST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -u <span style="color:#e6db74">&#34;</span>$PATCHWORK_USER<span style="color:#e6db74">:</span>$PATCHWORK_PASS<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -F <span style="color:#e6db74">&#34;state=</span>$state<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -F <span style="color:#e6db74">&#34;target_url=</span>$BUILD_URL<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -F <span style="color:#e6db74">&#34;context=</span>$JOB_NAME<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -F <span style="color:#e6db74">&#34;description=</span>$description<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">&#34;</span>$CHECK_URL<span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Main</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#75715e"># Sanity checks</span>

echo <span style="color:#e6db74">&#34;MBOX_URL=</span>$MBOX_URL<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;CHECK_URL=</span>$CHECK_URL<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;JOB_NAME=</span>$JOB_NAME<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;BUILD_URL=</span>$BUILD_URL<span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Notify the user that the build is starting</span>
submit_check <span style="color:#e6db74">&#34;pending&#34;</span>

<span style="color:#75715e"># Navigate to the Patchwork directory</span>
cd patchwork <span style="color:#f92672">||</span> exit

<span style="color:#75715e"># Configure fake git credentials so we can use git-am</span>
git config user.name <span style="color:#e6db74">&#39;John Doe&#39;</span>
git config user.email <span style="color:#e6db74">&#39;john.doe@example.org&#39;</span>

<span style="color:#75715e"># Simply download and apply the mbox to ensure it still applies</span>
<span style="color:#66d9ef">if</span> ! curl <span style="color:#e6db74">&#34;</span>$MBOX_URL<span style="color:#e6db74">&#34;</span> | git am -3; <span style="color:#66d9ef">then</span>
  submit_check <span style="color:#e6db74">&#34;fail&#34;</span>
  exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">else</span>
  submit_check <span style="color:#e6db74">&#34;success&#34;</span>
  exit <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>You&rsquo;ll notice we&rsquo;re really not taking advantage of Jenkins' power here but
bear with me: these are baby steps.</p>
<p>Once done, you should have something like the following:</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-6.png"
         alt="Screenshot of Build configuration"/> <figcaption>
            <h4>Build</h4>
        </figcaption>
</figure>

<p>Finally, the <em>Post-build Actions</em>. I didn&rsquo;t make use of this section, though
I&rsquo;m sure the above script could be broken up to make use of this. Some other
time, perhaps.</p>
<figure>
    <img src="https://that.guru/media/patchwork-and-ci-in-a-tree-7.png"
         alt="Screenshot of Post-build Actions"/> <figcaption>
            <h4>Post-build Actions</h4>
        </figcaption>
</figure>

<h3 id="summary-1">Summary</h3>
<p>Once this step is complete, you should have configured a basic Jenkins job that
can be kicked off using the API. This job uses the credentials and IP of the
Patchwork instance. You&rsquo;ll also have a token for your Jenkins user, which we
will use to talk to the Jenkins API.</p>
<h2 id="poll-patchwork-and-kick-of-jenkins-builds">Poll Patchwork and Kick of Jenkins Builds</h2>
<p>We&rsquo;re going to use a rather simple Bash script to kick of the Jenkins build. We
could do the exact same thing in Python (it would likely be more robust), but
Bash makes for a good first pass. The script consists of a number of different
parts: all should be combined to produce the final scripts.</p>
<p>Note that the below script(s) makes use of the <code>jq</code> tool to parse JSON. This is
not part of the default install on many distros, and may need to be installed
manually. You should do this now. For example, on Fedora 25 run:</p>
<pre><code>$ sudo dnf install jq
</code></pre>
<p>First up in the script: Jenkins and Patchwork credentials. We&rsquo;re going to
hard-code these for now, using the Jenkins username and token and Patchwork
username and password we configured/collected earlier. We&rsquo;re also going to
create some function stubs, which we will populate later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Constants</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#75715e"># Patchwork credentials</span>

readonly PATCHWORK_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;172.17.0.3:8000&#34;</span>
readonly PATCHWORK_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
readonly PATCHWORK_PASS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tester&#34;</span>

<span style="color:#75715e"># Jenkins credentials</span>

readonly JENKINS_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:8080&#34;</span>
readonly JENKINS_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
readonly JENKINS_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;962ccd82ce467804ec7e465602381d12&#34;</span>
readonly JENKINS_CRUMB<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s <span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">${</span>JENKINS_USER<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>JENKINS_TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">@</span><span style="color:#e6db74">${</span>JENKINS_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\&#34;:\&#34;,//crumb)&#34;</span><span style="color:#66d9ef">)</span>

<span style="color:#75715e"># Job configuration</span>

readonly JOB_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;checkstyle&#34;</span>
readonly JOB_TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello-world&#34;</span>

<span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Functions</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#66d9ef">function</span> submit_job<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e"># TODO</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Note that Jenkins requires that you supply a &ldquo;crumb&rdquo; with all requests to
prevent CSRF, so we gather that now. More information is provided in <a href="http://stackoverflow.com/a/38314369/613428">this
StackOverflow question</a> and in the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API">remote access API wiki</a>.</p>
<p>Next, the polling of <code>/events</code>. This is an endpoint in the Patchwork REST API
that reports events related to elements like patches, series or checks. A list
of all supported events is <a href="#">provided in the docs</a> but there are two that we
care about here: <code>patch-created</code> and <code>patch-complete</code>. Per the docs, the first
of these occurs when a patch is added to Patchwork. The second, meanwhile,
occurs when all dependencies (if any) are met. This means that if a two patch
series is sent to Patchwork and the second patch is received first, only the
<code>patch-created</code> event will be created for this patch. Only when the first patch
in that series (the second patch&rsquo;s only dependency) is received will the
<code>patch-completed</code> be raised for the second patch (the <code>patch-created</code> and
<code>patch-completed</code> events will be raised at the same time for the first patch,
given that it has no dependencies per se).</p>
<p>The below section of the script deals with reading these events from the
Patchwork API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">##################################################</span>
<span style="color:#75715e"># Main</span>
<span style="color:#75715e">##################################################</span>

<span style="color:#75715e"># Pull in latest events</span>

response<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -s -u <span style="color:#e6db74">&#34;</span>$PATCHWORK_USER<span style="color:#e6db74">:</span>$PATCHWORK_PASS<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Host: </span>$PATCHWORK_URL<span style="color:#e6db74"> \
</span><span style="color:#e6db74">  http://</span><span style="color:#e6db74">${</span>PATCHWORK_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/1.0/events/?category=patch-completed)
</span></code></pre></div><p><strong>Note:</strong> The use of the <code>Host:</code> header is important - without this, responses
will be returned using <code>localhost</code> as the host name. This won&rsquo;t be usable from
another container.</p>
<p>The response from the <code>/events</code> API will include links to the created patch
and, for the <code>patch-completed</code> event, the patch series which is providing the
dependencies. We must retrieve the patch and series from the Patchwork API.
Note that, in a future version of the API, we should support an <code>embed</code>
parameter that would allow us to embed the patch and series in the response and
avoid these additional requests.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Extract patch and series URLs from each event, and create jobs based on</span>
<span style="color:#75715e"># these</span>

patches_series<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$response<span style="color:#e6db74">&#34;</span> | jq -rc <span style="color:#e6db74">&#39;.[] | .payload.patch.url + &#34;,&#34; + .payload.series.id&#39;</span><span style="color:#66d9ef">)</span>
echo <span style="color:#e6db74">&#34;</span>$patches_series<span style="color:#e6db74">&#34;</span> | <span style="color:#66d9ef">while</span> IFS<span style="color:#f92672">=</span>, read -r patch series; <span style="color:#66d9ef">do</span>
  echo <span style="color:#e6db74">&#34;Submitting job&#34;</span>
  echo <span style="color:#e6db74">&#34;Patch URL: </span>$patch<span style="color:#e6db74">&#34;</span>
  echo <span style="color:#e6db74">&#34;Series ID: </span>$series<span style="color:#e6db74">&#34;</span>

  submit_job <span style="color:#e6db74">&#34;</span>$patch<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$series<span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>Once we have the <code>patch_url</code> and <code>series_id</code>, we can submit the job to Jenkins.
We&rsquo;re going to do this via a call to the <code>submit_job</code> function, which we
already defined a stub for. Implementing this function is rather simple, given
that we have already configured the job and gathered all required parameters
and credentials. Replace the above stub with the below function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#66d9ef">function</span> submit_job<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local patch_url
  local series_id
  local mbox_url
  local build_url

  patch<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
  series_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>

  mbox_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo $patch | jq -rc <span style="color:#e6db74">&#39;.mbox&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">?series=</span>$series_id<span style="color:#e6db74">&#34;</span>
  check_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo $patch | jq -rc <span style="color:#e6db74">&#39;.checks&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  build_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://</span>$JENKINS_USER<span style="color:#e6db74">:</span>$JENKINS_TOKEN<span style="color:#e6db74">@</span>$JENKINS_URL<span style="color:#e6db74">/job/</span>$JOB_NAME<span style="color:#e6db74">/build&#34;</span>

  echo <span style="color:#e6db74">&#34;Submitting job: </span>$build_url<span style="color:#e6db74">&#34;</span>
  echo <span style="color:#e6db74">&#34;Job parameters: PATCH_MBOX_URL=</span>$mbox_url<span style="color:#e6db74">, CHECK_URL=</span>$check_url<span style="color:#e6db74">&#34;</span>

  curl -X POST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -H <span style="color:#e6db74">&#34;</span>$JENKINS_CRUMB<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --data token<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$JOB_TOKEN<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --data-urlencode json<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">      &#34;parameter&#34;: [
</span><span style="color:#e6db74">        {&#34;name&#34;:&#34;MBOX_URL&#34;, &#34;value&#34;:&#34;&#39;</span><span style="color:#e6db74">&#34;</span>$mbox_url<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;&#34;},
</span><span style="color:#e6db74">        {&#34;name&#34;:&#34;CHECK_URL&#34;, &#34;value&#34;:&#34;&#39;</span><span style="color:#e6db74">&#34;</span>$check_url<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;&#34;}
</span><span style="color:#e6db74">      ]
</span><span style="color:#e6db74">    }&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">&#34;</span>$build_url<span style="color:#e6db74">&#34;</span>

  echo <span style="color:#e6db74">&#34;Job submitted&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>There are a two important points to note related to how the Jenkins API works:</p>
<ul>
<li>
<p>The Jenkins API requires parameters be passed via a JSON body rather than
than individual fields. This differs from Patchwork.</p>
</li>
<li>
<p>The Jenkins API requires the inclusion of a <em>crumb</em> header, by way of the
<code>JENKINS_CRUMB</code> that we stored earlier. This is intended to prevent CSRF
attacks.</p>
</li>
</ul>
<p>More information on the Jenkins API can be found in <a href="https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API">remote access API
wiki</a>.</p>
<h2 id="add-patches-to-patchwork">Add Patches to Patchwork</h2>
<p>Once done, it&rsquo;s time to load in some patches. In practice, this would happen
automatically but, as this is for testing only, we&rsquo;re going to once again
follow the <a href="https://patchwork.readthedocs.io/en/latest/development/installation/#import-mailing-list-archives">Patchwork documentation</a> and make use Mailman archives. I
downloaded the archives for January 2017, like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl https://gist.github.com/stephenfin/d13183dad40f8c472234cb26777355c3 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    | gunzip &gt; sample-series.mbox
</code></pre></div><p>Note that this <em>must</em> be downloaded to the <code>patchwork</code> directory, else it will
not be accessible from the Docker containers.</p>
<p>Once downloaded, use the <code>parsearchive</code> tool provided with Patchwork to load
the archive:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose run web python manage.py parsearchive <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --list-id<span style="color:#f92672">=</span>patchwork.ozlabs.org <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    sample-series.mbox
</code></pre></div><p>Keep an eye on the <code>/events</code> URL - you should notice a few new patch events.</p>
<h2 id="go-time">Go Time</h2>
<p>Run the script on your host and watch the end result. That script will read the
events stream, filter the events we care about, and kick of Jenkins builds for
the patches you just added. Jenkins will then take over, reporting that it is
starting testing to Patchwork, actually running the tests, then reporting the
end result to Patchwork. You should be able to see the jobs running in Jenkins,
and the resulting checks reported in the API.</p>
<pre><code>http://localhost:8080/job/checkstyle/
http://localhost:8000/api/1.0/events/?category=patch-completed
</code></pre>
<h2 id="summary-2">Summary</h2>
<p>And so completes our demo. It&rsquo;s rather basic, involving a lot of &ldquo;shortcuts&rdquo;
and tinkering. However, it does demonstrate the coming together of many of the
features available in the next version of Patchwork, namely:</p>
<ul>
<li>
<p><em>Checks</em>, available in <a href="https://github.com/getpatchwork/patchwork/">Patchwork 1.1</a></p>
</li>
<li>
<p><em>REST API</em>, available in Patchwork 2.0</p>
</li>
<li>
<p><em>Series</em>, available in Patchwork 2.0</p>
</li>
<li>
<p><em>Events</em>, available in Patchwork 2.0</p>
</li>
</ul>
<p>Not all of these features are required for building an automated testing
system. For example, if you didn&rsquo;t want to test series or were happy testing
individual patches, you could skip the series support. Likewise, you don&rsquo;t have
to report test results to Patchwork and could poll the <code>/patches</code> or <code>/series</code>
endpoints instead of the <code>/events</code> endpoint to find patches to test.  In my
opinion though, this represents a great starting point for building an
sustainable, stable, and ultimately beneficial testing infrastructure for
projects using a mailing list workflow.</p>
<h2 id="whats-next">What&rsquo;s Next</h2>
<ul>
<li>
<p>A better permissions model for Patchwork users</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> support, allowing us to minimize requests to the API</p>
</li>
<li>
<p>Better upstream documentation</p>
</li>
</ul>

  </article>

  <div class="disqus">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thatguru" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

  <div class="categories">
    
    <a class="category" href="https://that.guru/categories/patchwork">#patchwork</a>
    
  </div>

    </main>
  </div>
</div>

<div class="footer-wrapper">
  <footer>
    <p>&copy; 2022 Stephen Finucane</p>

    <div class="social-links">
      <a class="social-link" alt="GitHub" href="https://github.com/stephenfin">
        <i class="fab fa-github"></i>
      </a>
      <a class="social-link" alt="Twitter" href="https://twitter.com/stephenfin">
        <i class="fab fa-twitter"></i>
      </a>
      <a class="social-link" alt="LinkedIn" href="https://linkedin.com/stephenfinucane">
        <i class="fab fa-linkedin"></i>
      </a>
      </div>
  </footer>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-80652159-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>
