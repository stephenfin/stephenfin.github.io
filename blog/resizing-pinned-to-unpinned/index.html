<!DOCTYPE html>
<html lang="en-IE">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Stephen Finucane">
<meta name="description" content="OpenStack Nova provides support for resize operations, or the changing of the flavor associated with instance. This allows you to add or remove resources from the instance, in addition to modifying other configuration associated with the flavor.
There were reports that resizing an instance from a pinned flavor to a unpinned one did not result in the pinning being removed. The opposite was also reportedly true. I investigated this to see if this was the case.">

<meta property="og:title" content="Resizing pinned instances to unpinned" />
<meta property="og:description" content="OpenStack Nova provides support for resize operations, or the changing of the flavor associated with instance. This allows you to add or remove resources from the instance, in addition to modifying other configuration associated with the flavor.
There were reports that resizing an instance from a pinned flavor to a unpinned one did not result in the pinning being removed. The opposite was also reportedly true. I investigated this to see if this was the case." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://that.guru/blog/resizing-pinned-to-unpinned/" />



<meta property="article:published_time" content="2016-06-30T10:55:58&#43;01:00"/>

<meta property="article:modified_time" content="2016-06-30T10:55:58&#43;01:00"/>












<title>


     Resizing pinned instances to unpinned 

</title>
<link rel="canonical" href="https://that.guru/blog/resizing-pinned-to-unpinned/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    <link rel="stylesheet" href="https://that.guru/css/reset.css">
    <link rel="stylesheet" href="https://that.guru/css/pygments.css">
    <link rel="stylesheet" href="https://that.guru/css/main.css">
    




<link rel="shortcut icon"

    href="https://that.guru/img/favicon.ico"

>








</head>


<body lang="">

<section class="header">
    <div class="container">
        <div class="content">
            
            <a href="https://that.guru/"><img class="avatar" src="https://gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=50" rcset="https://gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=100 2x, https://gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=150 3x, https://gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=200 4x"></a>
            
            <a href="https://that.guru/"><div class="name">Stephen Finucane</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-about"><a href="https://that.guru/about/"><span>About</span></a></li>
                    
                        <li class="nav-archives"><a href="https://that.guru/blog/"><span>Archives</span></a></li>
                    
                        <li class="nav-cv"><a href="https://that.guru/media/cv_stephen_finucane_-_may_2016.pdf"><span>CV</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="https://www.github.com/stephenfin" target="_blank" rel="noopener"><img class="icon" src="https://that.guru/img/github.svg" alt="github" /></a>
        

        
            <a href="https://www.twitter.com/stephenfin" target="_blank" rel="noopener"><img class="icon" src="https://that.guru/img/twitter.svg" alt="twitter" /></a>
        

	

        

        

        
            <a href="https://www.linkedin.com/in/stephenfinucane" target="_blank" rel="noopener"><img class="icon" src="https://that.guru/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        
            <a href="mailto:stephen@that.guru"><img class="icon" src="https://that.guru/img/email.svg" alt="email" /></a>
        

        

        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <div class="page-heading">

    Resizing pinned instances to unpinned

</div>

            <div class="markdown">
                

<p>OpenStack Nova provides support for <a href="http://docs.openstack.org/user-guide/cli_change_the_size_of_your_server.html">resize operations</a>, or the
changing of the <a href="http://docs.openstack.org/admin-guide/compute-flavors.html">flavor</a> associated with instance. This allows you to
add or remove resources from the instance, in addition to modifying other
configuration associated with the flavor.</p>

<p>There were reports that resizing an instance from a <a href="http://docs.openstack.org/admin-guide/compute-numa-cpu-pinning.html">pinned
flavor</a> to a unpinned one did not result in the pinning being
removed. The opposite was also reportedly true. I investigated this to see if
this was the case.</p>

<h1 id="steps">Steps</h1>

<h2 id="create-the-required-flavors">Create the required flavors</h2>

<p>The first step we&rsquo;ll do is create two new flavors - <code>test.unpinned</code> and
<code>test.pinned</code>. Begin by creating these:</p>

<pre><code>$ openstack flavor create test.unpinned \
  --id 100 --ram 2048 --disk 0 --vcpus 2
$ openstack flavor create test.pinned \
  --id 101 --ram 2048 --disk 0 --vcpus 2
$ openstack flavor set test.pinned --property &quot;hw:cpu_policy=dedicated&quot;

$ openstack flavor list
+-----+---------------+-------+------+-----------+-------+-----------+
| ID  | Name          |   RAM | Disk | Ephemeral | VCPUs | Is Public |
+-----+---------------+-------+------+-----------+-------+-----------+
| 1   | m1.tiny       |   512 |    1 |         0 |     1 | True      |
| 101 | test.unpinned |  2048 |    0 |         0 |     2 | True      |
| 101 | test.pinned   |  2048 |    0 |         0 |     2 | True      |
| 2   | m1.small      |  2048 |   20 |         0 |     1 | True      |
| 3   | m1.medium     |  4096 |   40 |         0 |     2 | True      |
| 4   | m1.large      |  8192 |   80 |         0 |     4 | True      |
| 42  | m1.nano       |    64 |    0 |         0 |     1 | True      |
| 5   | m1.xlarge     | 16384 |  160 |         0 |     8 | True      |
| 84  | m1.micro      |   128 |    0 |         0 |     1 | True      |
+-----+---------------+-------+------+-----------+-------+-----------+
</code></pre>

<h2 id="create-a-new-instance">Create a new instance</h2>

<p>Now create the new instance, based on the <code>test.pinned</code> flavor:</p>

<pre><code>$ openstack image list
+--------------------------------------+---------------------------------+--------+
| ID                                   | Name                            | Status |
+--------------------------------------+---------------------------------+--------+
| c44bba29-653e-4ddf-963d-442af4c33a13 | cirros-0.3.4-x86_64-uec         | active |
| 8b0284ee-ae6c-4e80-b5ee-26895d574717 | cirros-0.3.4-x86_64-uec-ramdisk | active |
| 855c2971-aedc-4d5f-a366-73bb14707965 | cirros-0.3.4-x86_64-uec-kernel  | active |
+--------------------------------------+---------------------------------+--------+

$ openstack server create --flavor=test.pinned \
  --image=cirros-0.3.4-x86_64-uec --wait test1
</code></pre>

<h2 id="validate-that-the-instance-is-pinned">Validate that the instance is pinned</h2>

<p>Ensure the instance is actually pinned in the first place before we resize
anything:</p>

<pre><code>$ openstack server list
+--------------------------------------+-------+--------+--------------------------------------------------------+
| ID                                   | Name  | Status | Networks                                               |
+--------------------------------------+-------+--------+--------------------------------------------------------+
| 857597cb-266b-4032-8030-e3cc76ebf0e7 | test1 | ACTIVE | private=10.0.0.3, fd2a:ec16:99e1:0:f816:3eff:fe99:df9f |
+--------------------------------------+-------+--------+--------------------------------------------------------+

$ sudo virsh list
 Id    Name                           State
----------------------------------------------------
 1     instance-00000001              running

$ sudo virsh dumpxml instance-00000001
&lt;domain type='kvm' id='1'&gt;
  &lt;name&gt;instance-00000001&lt;/name&gt;
  ...
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;cputune&gt;
    &lt;shares&gt;2048&lt;/shares&gt;
    &lt;vcpupin vcpu='0' cpuset='1'/&gt;
    &lt;vcpupin vcpu='1' cpuset='21'/&gt;
    &lt;emulatorpin cpuset='1,21'/&gt;
  &lt;/cputune&gt;
  &lt;numatune&gt;
    &lt;memory mode='strict' nodeset='0'/&gt;
    &lt;memnode cellid='0' mode='strict' nodeset='0'/&gt;
  &lt;/numatune&gt;
  ...
  &lt;cpu&gt;
    &lt;topology sockets='1' cores='1' threads='2'/&gt;
    &lt;numa&gt;
      &lt;cell id='0' cpus='0-1' memory='2097152' unit='KiB'/&gt;
    &lt;/numa&gt;
  &lt;/cpu&gt;
  ...
&lt;/domain&gt;
</code></pre>

<h2 id="resize-the-instance-to-the-unpinned-flavor">Resize the instance to the unpinned flavor</h2>

<p>Seeing as pinning was in effect, we can now resize to the <code>test.unpinned</code>
flavor:</p>

<pre><code>$ openstack server resize test1 --flavor test.unpinned --wait
complete

$ openstack server list
+--------------------------------------+-------+---------------+--------------------------------------------------------+
| ID                                   | Name  | Status        | Networks                                               |
+--------------------------------------+-------+---------------+--------------------------------------------------------+
| 857597cb-266b-4032-8030-e3cc76ebf0e7 | test1 | VERIFY_RESIZE | private=10.0.0.3, fd2a:ec16:99e1:0:f816:3eff:fe99:df9f |
+--------------------------------------+-------+---------------+--------------------------------------------------------+

$ openstack server resize test1 --confirm
</code></pre>

<h2 id="validate-that-the-instance-is-no-longer-pinned">Validate that the instance is no longer pinned</h2>

<p>Once resized, check to see if the instance has been unpinned:</p>

<pre><code>$ openstack server list
+--------------------------------------+-------+--------+--------------------------------------------------------+
| ID                                   | Name  | Status | Networks                                               |
+--------------------------------------+-------+--------+--------------------------------------------------------+
| 857597cb-266b-4032-8030-e3cc76ebf0e7 | test1 | ACTIVE | private=10.0.0.3, fd2a:ec16:99e1:0:f816:3eff:fe99:df9f |
+--------------------------------------+-------+--------+--------------------------------------------------------+

$ sudo virsh list
 Id    Name                           State
----------------------------------------------------
 2     instance-00000001              running

$ sudo virsh dumpxml instance-00000001
&lt;domain type='kvm' id='2'&gt;
  &lt;name&gt;instance-00000002&lt;/name&gt;
  ...
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;cputune&gt;
    &lt;shares&gt;2048&lt;/shares&gt;
  &lt;/cputune&gt;
  ...
&lt;/domain&gt;
</code></pre>

<h2 id="resize-the-instance-back-to-the-pinned-flavor">Resize the instance back to the pinned flavor</h2>

<p>Let&rsquo;s go back the other way, and resize back to the <code>test.pinned</code> flavor:</p>

<pre><code>$ openstack server resize test1 --flavor test.pinned --wait
complete

$ openstack server list
+--------------------------------------+-------+---------------+--------------------------------------------------------+
| ID                                   | Name  | Status        | Networks                                               |
+--------------------------------------+-------+---------------+--------------------------------------------------------+
| 857597cb-266b-4032-8030-e3cc76ebf0e7 | test1 | VERIFY_RESIZE | private=10.0.0.3, fd2a:ec16:99e1:0:f816:3eff:fe99:df9f |
+--------------------------------------+-------+---------------+--------------------------------------------------------+

$ openstack server resize test1 --confirm
</code></pre>

<h2 id="validate-that-the-instance-is-pinned-once-more">Validate that the instance is pinned once more</h2>

<p>Finally, ensure the instance is once again pinned:</p>

<pre><code>$ openstack server list
+--------------------------------------+-------+--------+--------------------------------------------------------+
| ID                                   | Name  | Status | Networks                                               |
+--------------------------------------+-------+--------+--------------------------------------------------------+
| 857597cb-266b-4032-8030-e3cc76ebf0e7 | test1 | ACTIVE | private=10.0.0.3, fd2a:ec16:99e1:0:f816:3eff:fe99:df9f |
+--------------------------------------+-------+--------+--------------------------------------------------------+

$ sudo virsh list
 Id    Name                           State
----------------------------------------------------
 3     instance-00000001              running

$ sudo virsh dumpxml instance-00000001
&lt;domain type='kvm' id='3'&gt;
  &lt;name&gt;instance-00000001&lt;/name&gt;
  ...
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;cputune&gt;
    &lt;shares&gt;2048&lt;/shares&gt;
    &lt;vcpupin vcpu='0' cpuset='1'/&gt;
    &lt;vcpupin vcpu='1' cpuset='21'/&gt;
    &lt;emulatorpin cpuset='1,21'/&gt;
  &lt;/cputune&gt;
  &lt;numatune&gt;
    &lt;memory mode='strict' nodeset='0'/&gt;
    &lt;memnode cellid='0' mode='strict' nodeset='0'/&gt;
  &lt;/numatune&gt;
  ...
  &lt;cpu&gt;
    &lt;topology sockets='1' cores='1' threads='2'/&gt;
    &lt;numa&gt;
      &lt;cell id='0' cpus='0-1' memory='2097152' unit='KiB'/&gt;
    &lt;/numa&gt;
  &lt;/cpu&gt;
  ...
&lt;/domain&gt;
</code></pre>

<h1 id="result">Result</h1>

<p>It is possible to resize from pinned to unpinned, and from unpinned to pinned.
No issues here.</p>

<h1 id="references">References</h1>

<ul>
<li><a href="http://docs.openstack.org/admin-guide/compute-flavors.html">OpenStack Administrator Guide: Compute flavors</a></li>
<li><a href="http://docs.openstack.org/admin-guide/compute-numa-cpu-pinning.html">OpenStack Administrator Guide: Enabling advanced CPU topologies in
guests</a></li>
</ul>

            </div>
        </div>
    </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-80652159-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

