<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Zero-downtime Upgrades With Alembic and SQLAlchemy | that.guru</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="og:site_name" content="Stephen Finucane (Fin-oo-can)" />
  
  <meta property="og:title" content="Zero-downtime Upgrades With Alembic and SQLAlchemy" />
  <meta property="og:description" content="This is the blog form of a talk I delivered at PyCon Ireland 2022. You can find the slides here and the source code here.&hellip;" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://that.guru/blog/zero-downtime-upgrades-with-alembic-and-sqlalchemy/" />
  <meta property="og:image" content="https://images.unsplash.com/photo-1572314961011-aece24e1cc48?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3wzODQ4Mzh8MHwxfGFsbHx8fHx8fHx8fDE3MjQ3NjQ1MDd8&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=1080" />


  <link rel="shortcut icon" href="https://that.guru/img/favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="https://that.guru/icon.png">

  <link rel="stylesheet" href="https://that.guru/css/normalize.css">
  <link rel="stylesheet" href="https://that.guru/css/main.css">
  <link rel="preload" href="https://that.guru/css/syntax.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/syntax.css"/></noscript>
  <link rel="preload" href="https://that.guru/css/fontawesome.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/fontawesome.css"/></noscript>
  <link rel="preload" href="https://that.guru/css/solid.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/solid.css"/></noscript>
  <link rel="preload" href="https://that.guru/css/brands.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://that.guru/css/brands.css"/></noscript>
  <style type="text/css">
    .header-wrapper {
      background-image: url(https://images.unsplash.com/photo-1572314961011-aece24e1cc48?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzODQ4Mzh8MHwxfGFsbHx8fHx8fHx8fDE3MjQ3NjQ1MDd8&ixlib=rb-4.0.3&q=80&w=1080);
    }
  </style>
</head>

<body>
<a class="home-button" href="https://that.guru/">
  <i class="fas fa-home"></i>
</a>

<div class="header-wrapper">
  <header class="header">
    <h1 class="title">Zero-downtime Upgrades With Alembic and SQLAlchemy</h1>

    <span class="header-attrib">
        Image by <a href="https://unsplash.com/@ussamaazam">
            ussamaazam
        </a> / <a href="https://unsplash.com/photos/pink-arrow-neon-sign-26h317_UMYM">Unsplash</a>
    </span>

    <nav class="site-nav">
      <div class="site-nav-left">
        <ul class="menu" role="menu">
          <li role="menuitem" class="menu-item"><a href="https://that.guru/blog">Blog</a></li>
          <li role="menuitem" class="menu-item"><a href="https://that.guru/talks">Talks</a></li>
          <li role="menuitem" class="menu-item"><a href="https://that.guru/cookbooks">Cookbooks</a></li>
          <li role="menuitem" class="menu-item"><a href="https://that.guru/about">About</a></li>
        </ul>
      </div>
      <div class="site-nav-right">
        <div class="social-links">
          <a class="social-link" alt="GitHub" href="https://github.com/stephenfin">
            <i class="fab fa-github"></i>
          </a>
          <a class="social-link" alt="Twitter" href="https://twitter.com/stephenfin">
            <i class="fab fa-twitter"></i>
          </a>
          <a class="social-link" alt="LinkedIn" href="https://linkedin.com/stephenfinucane">
            <i class="fab fa-linkedin"></i>
          </a>
          <a class="social-link" alt="RSS" href="https://that.guru/blog/index.xml">
            <i class="fas fa-rss"></i>
          </a>
        </div>
      </div>
    </nav>
  </header>
</div>

<div class="main-wrapper">
  <div class="main-inner">
    <main class="content">
  <div class="byline">
    <div class="byline-avatar">
      <a href="https://that.guru/about">
        <img src="https://www.gravatar.com/avatar/8fbd28ad59a1aa317a5ec175b0778359?s=40&d=retro" />
      </a>
    </div>
    <div class="byline-meta">
      <div>
        <address class="author"><a rel="author" href="https://that.guru/about">Stephen Finucane</address></a></address>
      </div>
      <div class="byline-meta-content">
        <time datetime='2022-11-13T00:00:00Z'>Nov 13, 2022</time>
        <span class="byline-reading-time"><span class="bull">&nbsp;•&nbsp;</span>20 min read</span>
      </div>
    </div>
  </div>

  <article>
    <p>This is the blog form of a talk I delivered at <a href="https://python.ie/pycon-2022/schedule/">PyCon Ireland 2022</a>. You can
find the slides <a href="https://that.guru/talks/zero-downtime-upgrades-with-alembic-and-sqlalchemy">here</a> and the source code
<a href="https://github.com/stephenfin/alembic-expand-contract-demo">here</a>.</p>
<p>One thing to note before we begin is that while I mention OpenStack services below, this article isn&rsquo;t actually about
OpenStack 😉 We&rsquo;re merely using it as a good example. The problems that OpenStack needs to address such as scaling out
services in larger deployments are common to most distributed services.</p>
<h2 id="background">Background</h2>
<p>In the beginning, there were only two OpenStack services: Swift, which was responsible for object-storage, and Nova, which handled everything else. Over time, the list of services has <a href="https://en.wikipedia.org/wiki/OpenStack#Release_history">grown enormously</a> as Nova has shed some of its former responsibilities to other services and the amounts of things an OpenStack cloud can do has grown. However, due to many projects&rsquo; shared heritage (where they were split out from or modeled on Nova) and general design decisions made in the early days of OpenStack, even the newest OpenStack services tend to have a couple of commonalities in their design. Two of these are relevant to this article. Firstly, many of the services are designed to be horizontally scalable and almost always use a message broker to achieve this. This message broker is typically RabbitMQ and it provides a way for multiple instances of a service to communicate with each other. Secondly, without fail, OpenStack services will use a traditional relational DB to store data. The database backend is usually MySQL (although PostgreSQL is also an option) while SQLAlchemy is used for them ORM.</p>
<p>These two design decisions are relevant because they contain an inherent conflict. There can be many instances of a service (e.g. <code>nova-conductor</code> or <code>nova-api</code>) but they will all share a single database. If the schema of the database changes then each of these services will need to understand the new format. Historically in OpenStack, the way to do this was to closely couple the source code and database schema. An upgrade to a new version of OpenStack would necessitate taking all services down, upgrading the service code and the database schema, and then restarting the services. It works but it requires potentially large API downtime: the table lock that MySQL grabs while migrating the schema will block all reads and writes until the migration is complete, and for large installations where tables can have many millions of rows that migration can take minutes if not hours. This isn&rsquo;t good enough for most production enterprise clouds, let alone specific applications like Telco where SLAs are something that the <em>government</em> cares about. What we want is the ability to do rolling upgrades. Enter expand-contract.</p>
<h2 id="the-expand-migrate-contract-pattern">The Expand-Migrate-Contract pattern</h2>
<p>We can start exploring the expand-contract pattern by thinking about what happens to the data in an application during a migration.</p>
<ul>
<li>Data can be added. For example, adding a new <code>name</code> field to a user account model.</li>
<li>Data can change. For example, <a href="https://shinesolutions.com/2018/01/08/falsehoods-programmers-believe-about-names-with-examples/">combining separate existing <code>first_name</code> and <code>last_name</code> fields into a single <code>name</code> field</a>.</li>
<li>Data can be deleted. For example, dropping the old <code>first_name</code> and <code>last_name</code> fields.</li>
</ul>
<p>The basic idea behind the expand-migrate-contract migration pattern is to split the schema migrations into two groups: additive changes, which will handle the added data, and contractive/destructive changes, which will handle the removed data. The changed data is an example of a data migration and either the application or another set of migrations handles this. If you&rsquo;re a visual person, you can visualize this like so:</p>
<figure><img src="https://that.guru/media/zero-downtime-upgrades-with-alembic-and-sqlalchemy-1.png"
    alt="A minimal real-world example of expand-migrate-contract"><figcaption>
      <h4>A visualization of expand-migrate-contract</h4>
    </figcaption>
</figure>

<p>By applying the expand-contract migration, we can move from an upgrade pattern like this:</p>
<ol>
<li>Stop all services</li>
<li>Upgrade the services and apply all database schema migrations.</li>
<li>Wait X minutes/hours/days for the schema migration to complete.</li>
<li>Restart all services</li>
</ol>
<p>To this:</p>
<ol>
<li>Apply the &ldquo;expand&rdquo; database schema migration</li>
<li>Upgrade the service instances one-by-one until all services have been upgraded</li>
<li>(Optional) Apply database data migrations</li>
<li>(At some future point) Apply the &ldquo;contract&rdquo; database schema migrations</li>
</ol>
<p>There are often a couple of additional steps that your application will need to do, but the basic idea here is that by adapting the expand-migrate-contract pattern in your application, you can both allow your database schema to evolve while avoiding undesirable downtime.</p>
<p>Now that we have all this background out of the way, where do Alembic and SQLAlchemy fit into this equation? I&rsquo;m glad you asked!</p>
<h2 id="initial-steps">Initial steps</h2>
<p>So before we start talking about alternative database upgrade plans, we need to have a platform to build on. To this end, let&rsquo;s create an initial project structure and populate it with some initial SQLAlchemy models. I&rsquo;ve based this on a slightly modified version of the sample models found in the <a href="https://docs.sqlalchemy.org/en/14/orm/quickstart.html#declare-models">SQLAlchemy quick start guide</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ mkdir -p alembic-expand-contract-demo/alembic_expand_contract_demo
</span></span><span style="display:flex;"><span>❯ cd alembic-expand-contract-demo
</span></span><span style="display:flex;"><span>❯ touch alembic_expand_contract_demo/__init__.py alembic_expand_contract_demo/models.py alembic_expand_contract_demo/README.md
</span></span></code></pre></div><p>Dump the following into the newly created <code>alembic_expand_contract_demo/models.py</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> Column
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> ForeignKey
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> Integer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> String
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> declarative_base
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> relationship
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user_account&#34;</span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> Column(Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    first_name <span style="color:#f92672">=</span> Column(String(<span style="color:#ae81ff">30</span>))
</span></span><span style="display:flex;"><span>    last_name <span style="color:#f92672">=</span> Column(String(<span style="color:#ae81ff">30</span>))
</span></span><span style="display:flex;"><span>    addresses <span style="color:#f92672">=</span> relationship(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Address&#34;</span>, back_populates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span>, cascade<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;all, delete-orphan&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;User(id=</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>id<span style="color:#e6db74">!r}</span><span style="color:#e6db74">)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Address</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;address&#34;</span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> Column(Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    email_address <span style="color:#f92672">=</span> Column(String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> Column(Integer, ForeignKey(<span style="color:#e6db74">&#34;user_account.id&#34;</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> relationship(<span style="color:#e6db74">&#34;User&#34;</span>, back_populates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;addresses&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Address(id=</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>id<span style="color:#e6db74">!r}</span><span style="color:#e6db74">)&#34;</span>
</span></span></code></pre></div><p>We&rsquo;ll also create our <code>requirements.txt</code> file and install those requirements.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat &gt; requirements.txt <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">sqlalchemy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">alembic
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>❯<span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> virtualenv .venv
</span></span><span style="display:flex;"><span>❯<span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> source .venv/bin/activate
</span></span><span style="display:flex;"><span>❯<span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> pip install -r requirements.txt
</span></span></code></pre></div><p>With our initial models in place, we can now proceed to creating the initial migration directory structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯<span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> alembic init alembic_expand_contract_demo/migrations
</span></span></code></pre></div><p>You should now have a directory structure like so:</p>
<pre tabindex="0"><code>.
├── alembic_expand_contract_demo
│   ├── __init__.py
│   ├── migrations
│   │   ├── env.py
│   │   ├── README
│   │   ├── script.py.mako
│   │   └── versions
│   ├── models.py
├── alembic.ini
├── README.md
└── requirements.txt
</code></pre><p>As suggested by the wizard, you&rsquo;ll want to make a few changes to the <code>alembic.ini</code> file created in the root of your directory. In particular, you&rsquo;ll want to configure the <code>[alembic] script_location</code> and <code>[alembic] sqlalchemy.url</code> settings. I used the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[alembic]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">script_location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">%(here)s/alembic_expand_contract_demo/migrations</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sqlalchemy.url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">sqlite:///alembic-expand-contract-demo.db</span>
</span></span></code></pre></div><p>You&rsquo;ll also need to configure the <code>env.py</code> file found in the new <code>alembic_expand_contract_demo/migrations</code> directory to point the <code>target_metadata</code> value to your base model. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic_expand_contract_demo <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target_metadata <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>Base<span style="color:#f92672">.</span>metadata
</span></span></code></pre></div><p>Finally, we&rsquo;ll modify the migration script template <code>script.py.mako</code> in the <code>alembic_expand_contract_demo/migrations</code> directory to remove the <code>downgrade</code> step: downgrades aren&rsquo;t all that useful in a production environment (back up your data!) and add needless complexity here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">--- alembic_expand_contract_demo/migrations/script.py.mako
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ alembic_expand_contract_demo/migrations/script.py.mako
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -2,9 +2,8 @@
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span> Revision ID: ${up_revision}
</span></span><span style="display:flex;"><span> Revises: ${down_revision | comma,n}
</span></span><span style="display:flex;"><span><span style="color:#f92672">-Create Date: ${create_date}
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span> &#34;&#34;&#34;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span> from alembic import op
</span></span><span style="display:flex;"><span> import sqlalchemy as sa
</span></span><span style="display:flex;"><span> ${imports if imports else &#34;&#34;}
</span></span><span style="display:flex;"><span><span style="color:#75715e">@@ -18,7 +17,3 @@ depends_on = ${repr(depends_on)}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span> def upgrade() -&gt; None:
</span></span><span style="display:flex;"><span>     ${upgrades if upgrades else &#34;pass&#34;}
</span></span><span style="display:flex;"><span><span style="color:#f92672">-
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-def downgrade() -&gt; None:
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    ${downgrades if downgrades else &#34;pass&#34;}
</span></span></span></code></pre></div><p>With all this in place, we can now create an initial empty database and generate our first migration (Alembic needs a database to compare against to generate the updated schema).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic upgrade head
</span></span></code></pre></div><p>Once this is run, you&rsquo;ll note a new <code>alembic-expand-contract-demo.db</code> SQLite database in your root directory. A quick look at the schema of this database shows an effectively empty table with only Alembic&rsquo;s own <code>alembic_version</code> table present. This is expected: while we have models in place, we don&rsquo;t yet have a Alembic migration to add them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ sqlite3 alembic-expand-contract-demo.db <span style="color:#e6db74">&#39;.dump&#39;</span>
</span></span><span style="display:flex;"><span>PRAGMA foreign_keys<span style="color:#f92672">=</span>OFF;
</span></span><span style="display:flex;"><span>BEGIN TRANSACTION;
</span></span><span style="display:flex;"><span>CREATE TABLE alembic_version <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        version_num VARCHAR<span style="color:#f92672">(</span>32<span style="color:#f92672">)</span> NOT NULL,
</span></span><span style="display:flex;"><span>        CONSTRAINT alembic_version_pkc PRIMARY KEY <span style="color:#f92672">(</span>version_num<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>COMMIT;
</span></span></code></pre></div><p>Since we&rsquo;d already wired everything up, we can now simply run the <code>revision</code> sub-command with the <code>--autogenerate</code> option and our migrations will be auto-generated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic revision --autogenerate --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Initial models&#39;</span>
</span></span><span style="display:flex;"><span>INFO  <span style="color:#f92672">[</span>alembic.runtime.migration<span style="color:#f92672">]</span> Context impl SQLiteImpl.
</span></span><span style="display:flex;"><span>INFO  <span style="color:#f92672">[</span>alembic.runtime.migration<span style="color:#f92672">]</span> Will assume non-transactional DDL.
</span></span><span style="display:flex;"><span>INFO  <span style="color:#f92672">[</span>alembic.autogenerate.compare<span style="color:#f92672">]</span> Detected added table <span style="color:#e6db74">&#39;user_account&#39;</span>
</span></span><span style="display:flex;"><span>INFO  <span style="color:#f92672">[</span>alembic.autogenerate.compare<span style="color:#f92672">]</span> Detected added table <span style="color:#e6db74">&#39;address&#39;</span>
</span></span><span style="display:flex;"><span>  Generating /home/stephenfin/demos/alembic-expand-contract-demo/alembic_expand_contract_demo/migrations/versions/a185a7b16d70_initial_models.py ...  <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>This generates a migration that will look something like the following, once comments are addressed and formatting cleaned up:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Initial models
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: 6cb93d555e2b
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;6cb93d555e2b&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>create_table(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;first_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;last_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>PrimaryKeyConstraint(<span style="color:#e6db74">&#39;id&#39;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>create_table(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;address&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;email_address&#39;</span>, sa<span style="color:#f92672">.</span>String(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;user_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>ForeignKeyConstraint(
</span></span><span style="display:flex;"><span>            [<span style="color:#e6db74">&#39;user_id&#39;</span>],
</span></span><span style="display:flex;"><span>            [<span style="color:#e6db74">&#39;user_account.id&#39;</span>],
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>PrimaryKeyConstraint(<span style="color:#e6db74">&#39;id&#39;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">downgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_table(<span style="color:#e6db74">&#39;address&#39;</span>)
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_table(<span style="color:#e6db74">&#39;user_account&#39;</span>)
</span></span></code></pre></div><p>Apply this and we should see the new tables in the database schema.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic upgrade head
</span></span><span style="display:flex;"><span>❯ sqlite3 alembic-expand-contract-demo.db <span style="color:#e6db74">&#39;.dump&#39;</span>
</span></span><span style="display:flex;"><span>PRAGMA foreign_keys<span style="color:#f92672">=</span>OFF;
</span></span><span style="display:flex;"><span>BEGIN TRANSACTION;
</span></span><span style="display:flex;"><span>CREATE TABLE alembic_version <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        version_num VARCHAR<span style="color:#f92672">(</span>32<span style="color:#f92672">)</span> NOT NULL,
</span></span><span style="display:flex;"><span>        CONSTRAINT alembic_version_pkc PRIMARY KEY <span style="color:#f92672">(</span>version_num<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>INSERT INTO alembic_version VALUES<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;6cb93d555e2b&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>CREATE TABLE user_account <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        id INTEGER NOT NULL,
</span></span><span style="display:flex;"><span>        first_name VARCHAR<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>        last_name VARCHAR<span style="color:#f92672">(</span>30<span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>        PRIMARY KEY <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>CREATE TABLE address <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        id INTEGER NOT NULL,
</span></span><span style="display:flex;"><span>        email_address VARCHAR NOT NULL,
</span></span><span style="display:flex;"><span>        user_id INTEGER NOT NULL,
</span></span><span style="display:flex;"><span>        PRIMARY KEY <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>        FOREIGN KEY<span style="color:#f92672">(</span>user_id<span style="color:#f92672">)</span> REFERENCES user_account <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>COMMIT;
</span></span></code></pre></div><p>Nothing complicated so far. Onto the meaty part.</p>
<h2 id="first-pass-at-expand-contract-using-alembic">First pass at expand-contract using Alembic</h2>
<p>We now have an initial application. Time to start thinking about how to upgrade it. Looking at our models, we&rsquo;ll note that we have separate <code>first_name</code> and <code>last_name</code> fields.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user_account&#34;</span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> Column(Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    first_name <span style="color:#f92672">=</span> Column(String(<span style="color:#ae81ff">30</span>))
</span></span><span style="display:flex;"><span>    last_name <span style="color:#f92672">=</span> Column(String(<span style="color:#ae81ff">30</span>))
</span></span><span style="display:flex;"><span>    addresses <span style="color:#f92672">=</span> relationship(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Address&#34;</span>, back_populates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span>, cascade<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;all, delete-orphan&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;User(id=</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>id<span style="color:#e6db74">!r}</span><span style="color:#e6db74">)&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s say we wanted to merge these two fields into a single combined field called <code>name</code>. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#75715e">@@ -17,8 +17,7 @@ Base = declarative_base()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> class User(Base):
</span></span><span style="display:flex;"><span>     __tablename__ = &#34;user_account&#34;
</span></span><span style="display:flex;"><span>     id = Column(Integer, primary_key=True)
</span></span><span style="display:flex;"><span><span style="color:#f92672">-    first_name = Column(String(30))
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    last_name = Column(String(30))
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+    name = Column(String)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>     addresses = relationship(
</span></span><span style="display:flex;"><span>         &#34;Address&#34;, back_populates=&#34;user&#34;, cascade=&#34;all, delete-orphan&#34;
</span></span><span style="display:flex;"><span>     )
</span></span></code></pre></div><p>We can auto-generate our migration once again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic revision --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Merge user names&#39;</span>
</span></span></code></pre></div><p>This will give us a migration like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: 0585005489f0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: 6cb93d555e2b
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0585005489f0&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;6cb93d555e2b&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>, sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;last_name&#39;</span>)
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;first_name&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">downgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;first_name&#39;</span>, sa<span style="color:#f92672">.</span>VARCHAR(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;last_name&#39;</span>, sa<span style="color:#f92672">.</span>VARCHAR(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>)
</span></span></code></pre></div><p>Clearly this isn&rsquo;t very useful as it would result in data loss: we need to migrate data before we can remove the old column. The easy way to address this would be to modify the migration to also migrate data as an intermediary step. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: 0585005489f0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: 6cb93d555e2b
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0585005489f0&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;6cb93d555e2b&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># schema migrations - expand</span>
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># data migrations</span>
</span></span><span style="display:flex;"><span>    bind <span style="color:#f92672">=</span> op<span style="color:#f92672">.</span>get_bind()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_account_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>MetaData(),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;first_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;last_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    names <span style="color:#f92672">=</span> bind<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>select(
</span></span><span style="display:flex;"><span>            [
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>first_name,
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>last_name,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    )<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> id, first_name, last_name <span style="color:#f92672">in</span> names:
</span></span><span style="display:flex;"><span>        bind<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>            user_account_table<span style="color:#f92672">.</span>update()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>where(user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> id)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>values(
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>first_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>last_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># schema migrations - contract</span>
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;first_name&#39;</span>)
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;last_name&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">downgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Irreversible migration&#34;</span>)
</span></span></code></pre></div><aside class="admonition note">
	
	
	<div class="admonition-content">We&rsquo;re using Python to do our data migrations here so this migration would not be able to run in Alembic&rsquo;s &ldquo;offline&rdquo; mode. You&rsquo;d need to rewrite this to use SQL if you wanted this functionality.</div>
</aside>

<p>While this works, as noted at the outset this approach doesn&rsquo;t work for scaled applications or applications with uptime guarantees: your applications would need to be taken offline while this database schema was applied, which itself is an operation that could take some time. Let&rsquo;s try an expand-contract approach instead. First, we&rsquo;ll do this manually. Instead of having one large migration file, we&rsquo;ll create three separate migration files (or two, if your application is going to take care of data migrations at runtime).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic revision --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Merge user names (expand)&#39;</span>
</span></span><span style="display:flex;"><span>❯ alembic revision --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Merge user names (migrate)&#39;</span>
</span></span><span style="display:flex;"><span>❯ alembic revision --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Merge user names (contract)&#39;</span>
</span></span></code></pre></div><p>In the &ldquo;expand&rdquo; migration, we add the new column:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names (expand)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: 9c36df1b3f62
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: 6cb93d555e2b
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;9c36df1b3f62&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;6cb93d555e2b&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>In the &ldquo;migrate&rdquo; migration, we migrate our data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names (migrate)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: c9afc30a70ee
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: 9c36df1b3f62
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;c9afc30a70ee&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;9c36df1b3f62&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># data migrations</span>
</span></span><span style="display:flex;"><span>    bind <span style="color:#f92672">=</span> op<span style="color:#f92672">.</span>get_bind()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_account_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>MetaData(),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;first_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;last_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    names <span style="color:#f92672">=</span> bind<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>select(
</span></span><span style="display:flex;"><span>            [
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>first_name,
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>last_name,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    )<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> id, first_name, last_name <span style="color:#f92672">in</span> names:
</span></span><span style="display:flex;"><span>        bind<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>            user_account_table<span style="color:#f92672">.</span>update()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>where(user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> id)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>values(
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>first_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>last_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>Finally, in the &ldquo;contract&rdquo; migration, we remove the old columns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names (contract)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: e629a4ea0677
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: c9afc30a70ee
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e629a4ea0677&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;c9afc30a70ee&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># schema migrations - contract</span>
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;first_name&#39;</span>)
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;last_name&#39;</span>)
</span></span></code></pre></div><p>This is better. However, it does mean you can&rsquo;t simply run <code>alembic upgrade head</code> as this would apply all migrations in one go, totally defeating the point. What we want is a way to only apply the <em>expand</em> migrations initially, waiting to apply the other migrations later once all our services have been updated. This leads us to&hellip;</p>
<h2 id="branches">Branches</h2>
<aside class="admonition note">
	
	
	<div class="admonition-content">From here on, we&rsquo;re going to take the <em>migrate</em> phase out of Alembic&rsquo;s hand and do this manually. This would better represent a world when the application(s) would do this work. It also simplifies our examples. However, there&rsquo;s no reason you couldn&rsquo;t have three phases instead of two in your own application.</div>
</aside>

<p>Per the <a href="https://alembic.sqlalchemy.org/en/latest/branches.html">Alembic docs</a>:</p>
<blockquote>
<p>A branch describes a point in a migration stream when two or more versions refer to the same parent migration as their ancestor.</p>
</blockquote>
<p>They&rsquo;re intended for scenarios where &ldquo;two divergent source trees, both containing Alembic revision files created independently within those source trees, are merged together into one&rdquo;. This could includes things like feature branches, where multiple developers are working on separate features and merge everything back in around the same time. However, we can also use them to separate our <em>expand</em> migrations from our <em>contract</em> migrations. Let&rsquo;s look at how we&rsquo;d do that. First the <em>expand</em> migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">--- alembic_expand_contract_demo/migrations/versions/9c36df1b3f62_merge_user_names_expand.py
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ alembic_expand_contract_demo/migrations/versions/9c36df1b3f62_merge_user_names_expand.py
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -11,7 +11,7 @@ import sqlalchemy as sa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> # revision identifiers, used by Alembic.
</span></span><span style="display:flex;"><span> revision = &#39;9c36df1b3f62&#39;
</span></span><span style="display:flex;"><span> down_revision = &#39;6cb93d555e2b&#39;
</span></span><span style="display:flex;"><span><span style="color:#f92672">-branch_labels = None
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+branch_labels = (&#39;expand&#39;,)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span> depends_on = None
</span></span></code></pre></div><p>All that we&rsquo;ve done here is added a new <code>expand</code> branch label. Nothing odd there. Next up, the <em>expand</em> migration. As noted above, we&rsquo;re actually going to skip this going forward since it&rsquo;s not totally relevant, so let&rsquo;s delete it and create a separate tool to manage the migrations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ rm alembic_expand_contract_demo/migrations/versions/c9afc30a70ee_merge_user_names_migrate.py
</span></span><span style="display:flex;"><span>❯ touch data-migration.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SPDX-License-Identifier: MIT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">migrate_data</span>():
</span></span><span style="display:flex;"><span>    engine <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>create_engine(<span style="color:#e6db74">&#39;sqlite:///alembic-expand-contract-demo.db&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user_account_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>,
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>MetaData(),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;first_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;last_name&#39;</span>, sa<span style="color:#f92672">.</span>String(length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> engine<span style="color:#f92672">.</span>connect() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        names <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>            sa<span style="color:#f92672">.</span>select(
</span></span><span style="display:flex;"><span>                [
</span></span><span style="display:flex;"><span>                    user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                    user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>first_name,
</span></span><span style="display:flex;"><span>                    user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>last_name,
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> id, first_name, last_name <span style="color:#f92672">in</span> names:
</span></span><span style="display:flex;"><span>            conn<span style="color:#f92672">.</span>execute(
</span></span><span style="display:flex;"><span>                user_account_table<span style="color:#f92672">.</span>update()
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span>where(user_account_table<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> id)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span>values(
</span></span><span style="display:flex;"><span>                    name<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>first_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>last_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    migrate_data()
</span></span></code></pre></div><p>Finally, the <em>contract</em> migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">--- alembic_expand_contract_demo/migrations/versions/e629a4ea0677_merge_user_names_contract.py
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ alembic_expand_contract_demo/migrations/versions/e629a4ea0677_merge_user_names_contract.py
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -9,8 +9,8 @@ from alembic import op
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span> # revision identifiers, used by Alembic.
</span></span><span style="display:flex;"><span> revision = &#39;e629a4ea0677&#39;
</span></span><span style="display:flex;"><span><span style="color:#f92672">-down_revision = &#39;c9afc30a70ee&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-branch_labels = None
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+down_revision = &#39;9c36df1b3f62&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+branch_labels = (&#39;contract&#39;,)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span> depends_on = None
</span></span></code></pre></div><p>Again, nothing too odd here. We add the <code>contract</code> branch label and change the down revision to reflect the fact that we removed the data migration.</p>
<p>With these changes in place, we now have the ability to apply the branches separately.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic upgrade expand
</span></span><span style="display:flex;"><span>❯ python data-migration.py
</span></span><span style="display:flex;"><span>❯ alembic upgrade contract
</span></span></code></pre></div><aside class="admonition note">
	
	
	<div class="admonition-content"><p>If you wanted to add additional migrations to either branch, you can use the <code>--branch-label</code> and <code>--depends-on</code> options to set the branch and dependency migration, respectively. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic revision <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --branch-label expand <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --depends-on 9c36df1b3f62 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --message <span style="color:#e6db74">&#34;Another expand type change&#34;</span>
</span></span></code></pre></div></div>
</aside>

<p>This is a further improvement from where we were, but we&rsquo;re still missing a huge feature: auto-generation. While we can pass the <code>--autogenerate</code> flag <code>alembic revision</code>, the generated migrations need a lot of work including manually splitting the operations into expand and contract branch migrations. It would be great if Alembic could do this for us. Turns out it can, but it needs a bit of work.</p>
<h2 id="extending-auto-generation-to-support-expand-contract">Extending auto-generation to support expand-contract</h2>
<p>What we need is a hook point to modify the migrations generated by Alembic so that we can separate them into <em>expand</em> migrations and <em>contract</em> migrations. To do this, Alembic provides <code>process_revision_directives</code> attribute to the <code>context.configure</code> API call found in <code>env.py</code>. From the <a href="https://alembic.sqlalchemy.org/en/latest/api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives">Alembic docs</a>:</p>
<blockquote>
<p><strong>process_revision_directives</strong> - a callable function that will be passed a structure representing the end result of an autogenerate or plain “revision” operation, which can be manipulated to affect how the alembic revision command ultimately outputs new revision scripts.</p>
</blockquote>
<p>Before we configure that attribute, let&rsquo;s create the callable function itself. To do this, we&rsquo;re going to make use of the <code>alembic.util.Dispatcher</code> class. This is a class that is normally responsible for generating per-backend SQL statements for each migration operation. Instead of using this to generate SQL statements, we can use it to sift through the operations generated by Alembic so we can split them into two phases. Let&rsquo;s look at how we can do this in practice. Create an new file, <code>alembic_expand_contract_demo/migrations/autogen.py</code> and dump the following into it. We&rsquo;ll discuss the contents of the file step-by-step in a bit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SPDX-License-Identifier: MIT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic.operations <span style="color:#f92672">import</span> ops
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic.util <span style="color:#f92672">import</span> Dispatcher
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic.util <span style="color:#f92672">import</span> rev_id <span style="color:#66d9ef">as</span> new_rev_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_ec_dispatcher <span style="color:#f92672">=</span> Dispatcher()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_revision_directives</span>(context, revision, directives):
</span></span><span style="display:flex;"><span>    directives[:] <span style="color:#f92672">=</span> list(_assign_directives(context, directives))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_assign_directives</span>(context, directives, phase<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> directive <span style="color:#f92672">in</span> directives:
</span></span><span style="display:flex;"><span>        decider <span style="color:#f92672">=</span> _ec_dispatcher<span style="color:#f92672">.</span>dispatch(directive)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            phases <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;expand&#39;</span>, <span style="color:#e6db74">&#39;contract&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            phases <span style="color:#f92672">=</span> (phase,)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> phase <span style="color:#f92672">in</span> phases:
</span></span><span style="display:flex;"><span>            decided <span style="color:#f92672">=</span> decider(context, directive, phase)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> decided:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">yield</span> decided
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>MigrationScript)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_migration_script_ops</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    op <span style="color:#f92672">=</span> ops<span style="color:#f92672">.</span>MigrationScript(
</span></span><span style="display:flex;"><span>        new_rev_id(),
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">.</span>UpgradeOps(
</span></span><span style="display:flex;"><span>            ops<span style="color:#f92672">=</span>list(
</span></span><span style="display:flex;"><span>                _assign_directives(context, directive<span style="color:#f92672">.</span>upgrade_ops<span style="color:#f92672">.</span>ops, phase)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">.</span>DowngradeOps(ops<span style="color:#f92672">=</span>[]),
</span></span><span style="display:flex;"><span>        message<span style="color:#f92672">=</span>directive<span style="color:#f92672">.</span>message,
</span></span><span style="display:flex;"><span>        head<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>phase<span style="color:#e6db74">}</span><span style="color:#e6db74">@head&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> op<span style="color:#f92672">.</span>upgrade_ops<span style="color:#f92672">.</span>is_empty():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>ModifyTableOps)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_modify_table_ops</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    op <span style="color:#f92672">=</span> ops<span style="color:#f92672">.</span>ModifyTableOps(
</span></span><span style="display:flex;"><span>        directive<span style="color:#f92672">.</span>table_name, 
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">=</span>list(_assign_directives(context, directive<span style="color:#f92672">.</span>ops, phase)),
</span></span><span style="display:flex;"><span>        schema<span style="color:#f92672">=</span>directive<span style="color:#f92672">.</span>schema,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> op<span style="color:#f92672">.</span>is_empty():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AddConstraintOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>CreateIndexOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>CreateTableOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AddColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_expands</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;expand&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropConstraintOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropIndexOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropTableOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_contracts</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;contract&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AlterColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_alter_column</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    is_expand <span style="color:#f92672">=</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;expand&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> is_expand <span style="color:#f92672">and</span> directive<span style="color:#f92672">.</span>modify_nullable <span style="color:#f92672">is</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">not</span> is_expand <span style="color:#f92672">and</span> directive<span style="color:#f92672">.</span>modify_nullable <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Don&#39;t know if operation is an expand or contract at the moment: &#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> directive
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>With that file in place, let&rsquo;s take a look at what it&rsquo;s doing. First, the <code>process_revision_directives</code> and <code>_assign_directives</code> functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>_ec_dispatcher <span style="color:#f92672">=</span> Dispatcher()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_revision_directives</span>(context, revision, directives):
</span></span><span style="display:flex;"><span>    directives[:] <span style="color:#f92672">=</span> list(_assign_directives(context, directives))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_assign_directives</span>(context, directives, phase<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> directive <span style="color:#f92672">in</span> directives:
</span></span><span style="display:flex;"><span>        decider <span style="color:#f92672">=</span> _ec_dispatcher<span style="color:#f92672">.</span>dispatch(directive)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            phases <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;expand&#39;</span>, <span style="color:#e6db74">&#39;contract&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            phases <span style="color:#f92672">=</span> (phase,)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> phase <span style="color:#f92672">in</span> phases:
</span></span><span style="display:flex;"><span>            decided <span style="color:#f92672">=</span> decider(context, directive, phase)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> decided:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">yield</span> decided
</span></span></code></pre></div><p>Hopefully this should be mostly self-explanatory. <code>process_revision_directives</code> is initial &ldquo;entry point&rdquo; and all it does is overwrites the provided list of directives with our modified set. <code>_assign_directives</code>, on the other hand, does the bulk heavy lifting. It&rsquo;s responsible for iterating through the generated directives calling the dispatcher for each phase that we&rsquo;re examining.</p>
<p>Next, we look to look at the dispatchers themselves. For each type of operation, we need to write a separate dispatcher. The top-level operation is the generation of the migration script itself a.k.a. the <a href="https://alembic.sqlalchemy.org/en/latest/api/operations.html#alembic.operations.ops.MigrationScript"><code>MigrationScript</code> operation</a>. Let&rsquo;s look at this first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>MigrationScript)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_migration_script_ops</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    op <span style="color:#f92672">=</span> ops<span style="color:#f92672">.</span>MigrationScript(
</span></span><span style="display:flex;"><span>        new_rev_id(),
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">.</span>UpgradeOps(
</span></span><span style="display:flex;"><span>            ops<span style="color:#f92672">=</span>list(
</span></span><span style="display:flex;"><span>                _assign_directives(context, directive<span style="color:#f92672">.</span>upgrade_ops<span style="color:#f92672">.</span>ops, phase)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">.</span>DowngradeOps(ops<span style="color:#f92672">=</span>[]),
</span></span><span style="display:flex;"><span>        message<span style="color:#f92672">=</span>directive<span style="color:#f92672">.</span>message,
</span></span><span style="display:flex;"><span>        head<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>phase<span style="color:#e6db74">}</span><span style="color:#e6db74">@head&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> op<span style="color:#f92672">.</span>upgrade_ops<span style="color:#f92672">.</span>is_empty():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> op
</span></span></code></pre></div><p>Again, hopefully there&rsquo;s nothing too complicated. This dispatcher generates a migration script container a filtered list of upgrade directives (and no downgrade directives). This filtered list is filtered by phase, and we also specify a <em>head</em> that corresponds to the phase (<code>expand@head</code> for the <em>expand</em> phase).</p>
<p>Moving on, in addition to the <code>MigrationScript</code> operation, we have one other &ldquo;meta&rdquo; operation to concern ourselves with: <code>ModifyTableOps</code>. Fortunately, this isn&rsquo;t too complicated. We basically ensure that all operations against a table are filtered by phase as we&rsquo;d expect:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>ModifyTableOps)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_modify_table_ops</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    op <span style="color:#f92672">=</span> ops<span style="color:#f92672">.</span>ModifyTableOps(
</span></span><span style="display:flex;"><span>        directive<span style="color:#f92672">.</span>table_name, 
</span></span><span style="display:flex;"><span>        ops<span style="color:#f92672">=</span>list(_assign_directives(context, directive<span style="color:#f92672">.</span>ops, phase)),
</span></span><span style="display:flex;"><span>        schema<span style="color:#f92672">=</span>directive<span style="color:#f92672">.</span>schema,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> op<span style="color:#f92672">.</span>is_empty():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> op
</span></span></code></pre></div><p>Now for the first &ldquo;real&rdquo; operations: the <em>expand</em> operations. These are <code>AddConstraintOp</code>, <code>CreateIndexOp</code>, <code>CreateTableOp</code>, and <code>AddColumnOp</code>. Let&rsquo;s look at the dispatcher for these.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AddConstraintOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>CreateIndexOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>CreateTableOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AddColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_expands</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;expand&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>Simply put, if we&rsquo;re in <em>expand</em> phase and encounter one of these operations, proceed as normal. If we&rsquo;re in the <em>contract</em> phase, skip it. As you&rsquo;d imagine, the dispatcher for the <em>contract</em> options - <code>DropConstraintOp</code>, <code>DropIndexOp</code>, <code>DropTableOp</code>, and <code>DropColumnOp</code> - works pretty similarly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropConstraintOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropIndexOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropTableOp)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>DropColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_contracts</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;contract&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><p>With the plain old create and destroy operations out of the way, we only have to take care of the remaining &ldquo;modify&rdquo; or &ldquo;alter&rdquo; operations. This consists of modifications to columns a.k.a. <code>AlterColumnOp</code>. The <code>AlterColumnOp</code> dispatcher is trickier that the others, so pay attention here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@_ec_dispatcher.dispatch_for</span>(ops<span style="color:#f92672">.</span>AlterColumnOp)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_alter_column</span>(context, directive, phase):
</span></span><span style="display:flex;"><span>    is_expand <span style="color:#f92672">=</span> phase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;expand&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> is_expand <span style="color:#f92672">and</span> directive<span style="color:#f92672">.</span>modify_nullable <span style="color:#f92672">is</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">not</span> is_expand <span style="color:#f92672">and</span> directive<span style="color:#f92672">.</span>modify_nullable <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> directive
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Don&#39;t know if operation is an expand or contract at the moment: &#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> directive
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>The only modification we support here is the modifying <code>NULL</code> constraints on columns. There are other modifications you can make, such as modifying the type or a server default but these operations should really involve a bit of manual intervention to handle correctly. What we&rsquo;ve said here is that if we&rsquo;re in the <em>expand</em> phase then settings a column to nullable is a-okay. Likewise, if we&rsquo;re in the <em>contract</em> phase then setting a column to non-nullable is also permissible. All other cases are forbidden though and will raise a <code>NotImplementedError</code> exception.</p>
<p>With this in place, the final step is to enable the processor by passing the <code>process_revision_directives</code> argument to the <code>context.configure</code> API call in <code>env.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">--- alembic_expand_contract_demo/migrations/env.py
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ alembic_expand_contract_demo/migrations/env.py
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -5,6 +5,7 @@ from sqlalchemy import engine_from_config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> from sqlalchemy import pool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> from alembic_expand_contract_demo import models
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+from alembic_expand_contract_demo.migrations import autogen
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>
</span></span><span style="display:flex;"><span> # this is the Alembic Config object, which provides
</span></span><span style="display:flex;"><span> # access to the values within the .ini file in use.
</span></span><span style="display:flex;"><span><span style="color:#75715e">@@ -68,6 +69,7 @@ def run_migrations_online() -&gt; None:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         context.configure(
</span></span><span style="display:flex;"><span>             connection=connection,
</span></span><span style="display:flex;"><span>             target_metadata=target_metadata,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            process_revision_directives=autogen.process_revision_directives,
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>         )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         with context.begin_transaction():
</span></span></code></pre></div><h2 id="testing-things-out">Testing things out</h2>
<p>Now that we have all of our machinery in place, it&rsquo;s time to take things for a spin. Let&rsquo;s test out auto-generation using similar commands to those we used as the beginning of the article.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic revision --autogenerate --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Merge user names&#39;</span>
</span></span></code></pre></div><p>The first thing we notice is that there are no longer one but <strong>two</strong> generations generated. This looks promising and looking at the migrations themselves things look even better. First the <em>expand</em> migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat alembic_expand_contract_demo/migrations/versions/1630422c66fe_merge_user_names.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: 1630422c66fe
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: 9c36df1b3f62
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1630422c66fe&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;9c36df1b3f62&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>add_column(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;user_account&#39;</span>, sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>Now the <em>contract</em> migration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ cat alembic_expand_contract_demo/migrations/versions/a142d030afc5_merge_user_names.py
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;Merge user names
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revision ID: a142d030afc5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Revises: e629a4ea0677
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> alembic <span style="color:#f92672">import</span> op
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># revision identifiers, used by Alembic.</span>
</span></span><span style="display:flex;"><span>revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a142d030afc5&#39;</span>
</span></span><span style="display:flex;"><span>down_revision <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e629a4ea0677&#39;</span>
</span></span><span style="display:flex;"><span>branch_labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>depends_on <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upgrade</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;last_name&#39;</span>)
</span></span><span style="display:flex;"><span>    op<span style="color:#f92672">.</span>drop_column(<span style="color:#e6db74">&#39;user_account&#39;</span>, <span style="color:#e6db74">&#39;first_name&#39;</span>)
</span></span></code></pre></div><p>Applying these works exactly as expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ alembic upgrade expand
</span></span><span style="display:flex;"><span>❯ alembic upgrade contract
</span></span></code></pre></div><p>Hurrah, everything worked (hopefully)! However, this is only the first step. While this is a marked improvement on where we were, there are a few improvements we could yet make. For one, the names of the files don&rsquo;t reveal information about whether a change is an <em>expand</em> or <em>contract</em> migration. You can figure this out by looking at the migrations themselves but it would be much nicer if we could somehow indicate this through the filenames or, better yet, by separating them into separate folders. The branches here are also long-running and it would be nice if we could apply, say, all expand migrations up to a specific release along with any contract migrations from the previous release (which should be okay to apply assuming you&rsquo;ve upgraded all services to the previous release version and have been running it for some time to migrate data). Both of these requests (and more!) can be achieved, but that&rsquo;s outside the scope of this article. I&rsquo;d highly recommend looking at the source code of the OpenStack Neutron project, which implements this functionality in a full-featured manner.</p>

  </article>

  <div class="disqus">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thatguru" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

  <div class="categories">
    
    <a class="category" href="https://that.guru/categories/python">#python</a>
    
    <a class="category" href="https://that.guru/categories/sqlalchemy">#sqlalchemy</a>
    
    <a class="category" href="https://that.guru/categories/alembic">#alembic</a>
    
  </div>

    </main>
  </div>
</div>

<div class="footer-wrapper">
  <footer>
    <p>&copy; 2024 Stephen Finucane</p>

    <div class="social-links">
      <a class="social-link" alt="GitHub" href="https://github.com/stephenfin">
        <i class="fab fa-github"></i>
      </a>
      <a class="social-link" alt="Twitter" href="https://twitter.com/stephenfin">
        <i class="fab fa-twitter"></i>
      </a>
      <a class="social-link" alt="LinkedIn" href="https://linkedin.com/stephenfinucane">
        <i class="fab fa-linkedin"></i>
      </a>
      </div>
  </footer>
</div>

<script src="https://that.guru/js/highlight.min.js"></script>



</body>
</html>
